<?php
/**
 * Naxero.com
 * Professional ecommerce integrations for Magento.
 *
 * PHP version 7
 *
 * @category  Magento2
 * @package   Naxero
 * @author    Platforms Development Team <contact@naxero.com>
 * @copyright Â© Naxero.com all rights reserved
 * @license   https://opensource.org/licenses/mit-license.html MIT License
 * @link      https://www.naxero.com
 */
?>

<?php $config = $block->getConfig() ?>
<?php if ($config): ?>
<?php
// Process the block display logic
if ($block->blockHelper->bypassOos($config['product']['id'])) {
    $productId = $config['product']['id'];
    $buttonId = $config['product']['button_id'];
    $purchaseData = $block->purchaseHelper->getPurchaseData();
    $productIsFree = $block->productHelper->isFree($productId);
    $methodCode = $productIsFree ? 'free' : $purchaseData['payment_token']['method_code'];
    $isWidgetView = $config['product']['display'] == 'widget';
    $isListView = $config['product']['display'] == 'list';
    $isPageView = $config['product']['display'] == 'view';
    $formKey = $config['product']['form_key'];
    $uiLogging = $config['debug']['debug_enabled'] && $config['debug']['ui_logging_enabled'];
    $showProductBox = $config['widgets']['widget_show_product'] && $config['product']['display'] != 'list' && $config['product']['display'] != 'page';
    $showQuantityBox = $isWidgetView && $config['widgets']['widget_show_product_quantity'];
    $buttonText = $block->blockHelper->getButtonText();
?>

<!-- Product box -->
<?php if ($showProductBox): ?>
<div class="nbn-product-box-container">
    <?= $block->widgetHelper->getProductBoxHtml($config) ?>
</div>
<?php endif; ?>

<!-- Purchase button -->
<div id="nbn-<?= $block->escapeHtmlAttr($productId) ?>" class="nbn-button-container">
    <!-- Quantity box -->
    <?php if ($showQuantityBox): ?>
        <?= $block->widgetHelper->getQuantityBoxHtml($config, $config['product']['quantity_limits']['min']) ?>
    <?php endif; ?>

    <!-- Button -->
    <button 
        id="<?= $block->escapeHtmlAttr($buttonId) ?>"
        data-product-id="<?= $block->escapeHtmlAttr($productId) ?>"
        type="button"
        disabled="disabled"
        class="<?= $block->escapeHtmlAttr($block->purchaseHelper->getButtonCss()) ?> action primary instant-purchase nbn-button"
        title="<?= $block->escapeHtmlAttr(__($buttonText)) ?>">
        <?= $block->escapeHtml(__($buttonText)) ?>
    
        <?php if ($uiLogging): ?>
            <div id="nbn-ui-logger-button-<?= $block->escapeHtmlAttr($productId) ?>" class="nbn-ui-logger-button">
                <a href="javascript:void(0)" title="<?= $block->escapeHtmlAttr(__('View logs')) ?>">&#9432;</a>
            </div>
        <?php endif; ?> 
    </button>

    <!-- Form -->
    <?php if (!$isPageView): ?>
        <form name="nbn-list-form" method="post" class="nbn-list-form">
    <?php endif; ?>
        <input type="hidden" name="nbn[<?= $block->escapeHtmlAttr($productId) ?>][instant_purchase_payment_token]" value="<?= $purchaseData['payment_token']['public_hash'] ?>" />
        <input type="hidden" name="nbn[<?= $block->escapeHtmlAttr($productId) ?>][instant_purchase_method_code]" value="<?= $methodCode ?>" />
        <input type="hidden" name="nbn[<?= $block->escapeHtmlAttr($productId) ?>][instant_purchase_shipping_address]" value="<?= $purchaseData['shipping_address']['id'] ?>" />
        <input type="hidden" name="nbn[<?= $block->escapeHtmlAttr($productId) ?>][instant_purchase_billing_address]" value="<?= $purchaseData['billing_address']['id'] ?>" />
        <input type="hidden" name="nbn[<?= $block->escapeHtmlAttr($productId) ?>][instant_purchase_carrier]" value="<?= $purchaseData['shipping_method']['carrier'] ?>" />
        <input type="hidden" name="nbn[<?= $block->escapeHtmlAttr($productId) ?>][instant_purchase_shipping]" value="<?= $purchaseData['shipping_method']['method'] ?>" />

        <?php if (!empty($config['product']['options'])): ?>
            <?php foreach ($config['product']['options'] as $option): ?>
                <input type="hidden" id="nbn-super-attribute-<?= $block->escapeHtmlAttr($productId) ?>-<?= $block->escapeHtmlAttr($option['attribute_id']) ?>" name="nbn[<?= $block->escapeHtmlAttr($productId) ?>][super_attribute][<?= $block->escapeHtmlAttr($option['attribute_id']) ?>]" value="" />
            <?php endforeach; ?>
        <?php endif; ?>

        <input id="nbn-form-key-<?= $block->escapeHtmlAttr($productId) ?>" type="hidden" name="form_key" value="<?= $block->escapeHtmlAttr($formKey) ?>">
        <input id="nbn-product-data-<?= $block->escapeHtmlAttr($productId) ?>" type="hidden" name="nbn-product-data-<?= $block->escapeHtmlAttr($productId) ?>" value="<?= $block->escapeHtmlAttr(json_encode($config['product'])) ?>">

    <?php if (!$isPageView): ?>
        </form>
    <?php endif; ?>

    <script type="text/x-magento-init">
        {
            "*": {
                "nbn": <?= json_encode(['jsConfig' => $config], true) ?>
            }
        }
    </script>
</div>
<?php } ?>
<?php endif; ?>
