<?php $config = $block->getConfig() ?>
<?php if ($config): ?>
<?php
    // Process the block display logic
    if ($this->blockHelper->bypassOos($config['product']['id'])) {
        $productId = $config['product']['id'];
        $buttonId = $config['product']['button_id'];
        $purchaseData = $block->purchaseHelper->getPurchaseData();
        $productIsFree = $block->productHelper->isFree($productId);
        $methodCode = $productIsFree ? 'free' : $purchaseData['payment_token']['method_code'];
        $isBlockView = $config['product']['display'] == 'block';
        $isPageView = $config['product']['display'] == 'view';
        $formKey = $config['product']['form_key'];
        $uiLogging = $config['general']['debug_enabled'] && $config['general']['ui_logging_enabled'];
        $showProductBox = $config['popups']['show_product'];

    }
?>

<!-- Product box -->
<?php if ($showProductBox): ?>
    <div class="aip-product-box-container">
        <?= $this->blockHelper->renderProductBox($productId) ?>
    </div>
<?php endif; ?>

<div id="aip-<?= $productId ?>" class="aip-button-container">
    <!-- Button -->
    <button 
        id="<?= $buttonId ?>"
        type="button"
        class="<?= $block->purchaseHelper->getButtonCss() ?> action primary instant-purchase aip-button"
        title="<?= __($config['buttons']['button_text']) ?>">
        <?= __($config['buttons']['button_text']) ?>
    
        <?php if ($uiLogging): ?>
            <div id="aip-ui-logger-button-<?= $productId ?>" class="aip-ui-logger-button">
                <a href="javascript:void(0)" title="<?= __('View logs') ?>">&#9432;</a>
            </div>
        <?php endif; ?> 
    </button>

    <!-- Form -->
    <?php if (!$isPageView): ?>
        <form name="aip-list-form" method="post" class="aip-list-form">
    <?php endif; ?>
        <input type="hidden" name="aip[<?= $productId ?>][instant_purchase_payment_token]" value="<?= $purchaseData['payment_token']['public_hash'] ?>" />
        <input type="hidden" name="aip[<?= $productId ?>][instant_purchase_method_code]" value="<?= $methodCode ?>" />
        <input type="hidden" name="aip[<?= $productId ?>][instant_purchase_shipping_address]" value="<?= $purchaseData['shipping_address']['id'] ?>" />
        <input type="hidden" name="aip[<?= $productId ?>][instant_purchase_billing_address]" value="<?= $purchaseData['billing_address']['id'] ?>" />
        <input type="hidden" name="aip[<?= $productId ?>][instant_purchase_carrier]" value="<?= $purchaseData['shipping_method']['carrier'] ?>" />
        <input type="hidden" name="aip[<?= $productId ?>][instant_purchase_shipping]" value="<?= $purchaseData['shipping_method']['method'] ?>" />

        <?php if ($isBlockView && !empty($config['product']['options'])): ?>
            <?php foreach ($config['product']['options'] as $option): ?>
                <input type="hidden" id="super_attribute_<?= $option['attribute_id'] ?>" name="super_attribute[<?= $option['attribute_id'] ?>]" value="" />
            <?php endforeach; ?>
        <?php endif; ?>

        <input type="hidden" name="form_key" value="<?= $formKey ?>" />
    <?php if (!$isPageView): ?>
        </form>
    <?php endif; ?>

    <script type="text/x-magento-init">
        {
            "*": {
                "aip": <?= json_encode(['jsConfig' => $config], true) ?>
            }
        }
    </script>
</div>
<?php endif; ?> 

