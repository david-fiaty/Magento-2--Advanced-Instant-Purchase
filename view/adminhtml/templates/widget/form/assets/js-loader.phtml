<?php
/**
 * Naxero.com
 * Professional ecommerce integrations for Magento.
 *
 * PHP version 7
 *
 * @category  Magento2
 * @package   Naxero
 * @author    Platforms Development Team <contact@naxero.com>
 * @copyright Â© Naxero.com all rights reserved
 * @license   https://opensource.org/licenses/mit-license.html MIT License
 * @link      https://www.naxero.com
 */
?>

<script>
require([
    'jquery',
    'mage/translate',
    'select2',
    'domReady!'
], function($, __, select2) {
    'use strict';

    // Selectors
    var categorySelector = $('#' + $('#nbn-category-selector').val());
    var productSelector = $('select[name="parameters=[product_id]"]');

    // Category selector select
    categorySelector.select2({
        placeholder: __('Filter by category'),
        theme: 'classic',
        templateResult: function (data) { 
            // Hierarchical display for sub categories
            if (!data.element) {
                return data.text;
            }
            var $element = $(data.element);
            var $wrapper = $('<span></span>');
            $wrapper.addClass($element[0].className);
            $wrapper.text(data.text);

            return $wrapper;
        }
    });    

    // Category selector change event
    categorySelector.on('change', updateProductSelector);

    // Product selector select
    productSelector.select2({
        placeholder: __('Select an option'),
        theme: 'classic'
    });

    // Product selector default values
    if (parseInt(categorySelector.val()) > 0) {
        updateProductSelector();
    }

    // Product filter selector
    var productFilterSelector = $('#' + $('#nbn-product-filter-selector').val());
    productFilterSelector.select2({
        placeholder: __('Select an option'),
        minimumResultsForSearch: -1,
        theme: 'classic'
    });

    // Functions
    function updateProductSelector() {
        // Prepare the parameters
        var updateUrl = '<?= $block->escapeUrl($block->getUrl('naxero-buynow/widget/form')); ?>';
        var params = {
            category_id: categorySelector.val(),
            form_key: window.FORM_KEY
        };

        // Ajax request
        $.ajax({
            url: updateUrl,
            data: params,
            type: 'post',
            dataType: 'json',
            success: function (data) {
                productSelector.empty().html(data.html);
            },
            error: function (request, status, error) {
                console.log(error);
            }
        });
    }
});
</script>